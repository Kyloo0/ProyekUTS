{% extends "base.html" %}

{% block title %}Match Olahraga{% endblock %}

{% block content %}
{% if not schema_ready %}
<section class="system-message">
    <h2>Basis Data Belum Siap</h2>
    <p>
        Untuk menggunakan fitur match, jalankan perintah
        <code>python manage.py migrate</code> agar tabel yang diperlukan tersedia.
    </p>
</section>
{% endif %}

<section>
    <h2>Cari Match</h2>
    <form id="match-search-form" method="get" action="">
        {{ search_form.as_p }}
        <button type="submit" {% if not schema_ready %}disabled{% endif %}>Cari</button>
    </form>
</section>

<section>
    <h2>Buat Match Baru</h2>
    <form id="match-create-form" method="post" action="{% url 'matches:create_match' %}">
        {% csrf_token %}
        {{ match_form.as_p }}
        <button type="submit" {% if not schema_ready %}disabled{% endif %}>Buat Match</button>
    </form>
</section>

<div id="create-match-modal" class="modal" data-open="false" aria-hidden="true">
    <div class="modal-overlay" role="presentation"></div>
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="create-match-modal-title">
        <button type="button" class="modal-close" aria-label="Tutup">&times;</button>
        <h3 id="create-match-modal-title">Buat Match Baru</h3>
        <form id="match-create-form" method="post" action="{% url 'matches:create_match' %}">
            {% csrf_token %}
            {{ match_form.as_p }}
            <div class="modal-actions">
                <button type="button" class="modal-cancel">Batal</button>
                <button type="submit">Simpan</button>
            </div>
        </form>
    </div>
</div>

<section>
    <h2>Daftar Match</h2>
    <div id="match-list">
        {% if schema_ready %}
            {% if has_any_match %}
                {% for category, matches in grouped_matches %}
                    {% if matches %}
                        <section data-category="{{ category.slug }}">
                            <h3>{{ category.name }}</h3>
                            {% for match in matches %}
                                <article data-match-id="{{ match.id }}">
                                    <h4>{{ match.title }}</h4>
                                    <p>Lokasi: {{ match.location }}</p>
                                    <p>Waktu: {{ match.event_date|date:"d M Y H:i" }}</p>
                                    <p>Slot: {{ match.current_members }} / {{ match.max_members }} (tersisa {{ match.available_slots }})</p>
                                    {% if match.description %}
                                        <p>{{ match.description }}</p>
                                    {% endif %}
                                    <form class="booking-form" data-match-id="{{ match.id }}" method="post" action="{% url 'matches:book_match' match.id %}">
                                        {% csrf_token %}
                                        <p>
                                            <label>Nama<br><input type="text" name="name" required></label>
                                        </p>
                                        <p>
                                            <label>Kontak<br><input type="text" name="contact" required></label>
                                        </p>
                                        <p>
                                            <label>Catatan<br><textarea name="message" rows="3"></textarea></label>
                                        </p>
                                        <button type="submit">Gabung Match</button>
                                    </form>
                                </article>
                            {% endfor %}
                        </section>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p>Belum ada match yang tersedia.</p>
            {% endif %}
        {% else %}
            <p>Data match belum tersedia karena basis data belum dimigrasikan.</p>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
{% if schema_ready %}
<script>
(function() {
    const body = document.body;
    const searchForm = document.getElementById('match-search-form');
    const createForm = document.getElementById('match-create-form');
    const matchList = document.getElementById('match-list');
    const csrfToken = getCookie('csrftoken');
    const modal = document.getElementById('create-match-modal');
    const openModalButton = document.getElementById('open-create-modal');
    const modalOverlay = modal ? modal.querySelector('.modal-overlay') : null;
    const modalClose = modal ? modal.querySelector('.modal-close') : null;
    const modalCancel = modal ? modal.querySelector('.modal-cancel') : null;

    function openModal() {
        if (!modal) {
            return;
        }
        modal.setAttribute('data-open', 'true');
        modal.setAttribute('aria-hidden', 'false');
        body.style.overflow = 'hidden';
        const firstInput = modal.querySelector('.modal-content form input, .modal-content form textarea, .modal-content form select');
        if (firstInput) {
            firstInput.focus();
        }
    }

    function closeModal() {
        if (!modal) {
            return;
        }
        modal.setAttribute('data-open', 'false');
        modal.setAttribute('aria-hidden', 'true');
        body.style.overflow = '';
    }

    function bindModalEvents() {
        if (!modal) {
            return;
        }

        if (openModalButton) {
            openModalButton.addEventListener('click', openModal);
        }

        const closeActions = [modalOverlay, modalClose, modalCancel];
        closeActions.forEach(element => {
            if (element) {
                element.addEventListener('click', closeModal);
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && modal.getAttribute('data-open') === 'true') {
                closeModal();
            }
        });
    }

    function renderGroups(groups) {
        if (!groups || groups.length === 0) {
            matchList.innerHTML = '<p>Belum ada match yang sesuai pencarian.</p>';
            return;
        }

        const sectionHtml = groups.map(group => {
            const matchesHtml = group.matches.map(match => {
                const descriptionHtml = match.description ? `<p>${match.description}</p>` : '';
                return `
                    <article data-match-id="${match.id}">
                        <h4>${match.title}</h4>
                        <p>Lokasi: ${match.location}</p>
                        <p>Waktu: ${new Date(match.event_date).toLocaleString('id-ID')}</p>
                        <p>Slot: ${match.current_members} / ${match.max_members} (tersisa ${match.available_slots})</p>
                        ${descriptionHtml}
                        <form class="booking-form" data-match-id="${match.id}" method="post" action="/matches/${match.id}/book/">
                            <p>
                                <label>Nama<br><input type="text" name="name" required></label>
                            </p>
                            <p>
                                <label>Kontak<br><input type="text" name="contact" required></label>
                            </p>
                            <p>
                                <label>Catatan<br><textarea name="message" rows="3"></textarea></label>
                            </p>
                            <button type="submit">Gabung Match</button>
                        </form>
                    </article>
                `;
            }).join('');

            return `
                <section data-category="${group.category_slug}">
                    <h3>${group.category}</h3>
                    ${matchesHtml}
                </section>
            `;
        }).join('');

        matchList.innerHTML = sectionHtml;
        attachBookingHandlers();
    }

    async function loadMatches(formData) {
        const endpoint = searchForm.getAttribute('action') || window.location.pathname;
        const params = new URLSearchParams(formData || new FormData(searchForm));
        const queryString = params.toString();
        const url = queryString ? `${endpoint}?${queryString}` : endpoint;
        const response = await fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (!response.ok) {
            showToast('Gagal memuat data match.', 'error');
            return;
        }

        const data = await response.json();
        renderGroups(data.groups || []);
        return data;
    }

    async function handleCreate(event) {
        event.preventDefault();
        const formData = new FormData(createForm);

        const response = await fetch(createForm.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.json();
            const messages = Object.values(errorData.errors || {}).flat().join(' ');
            showToast(messages || 'Gagal membuat match baru.', 'error');
            return;
        }

        await response.json();
        createForm.reset();
        showToast('Match baru berhasil dibuat.', 'success');
        closeModal();
        await loadMatches();
    }

    async function handleBooking(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            const messages = Object.values(data.errors || {}).flat().join(' ');
            showToast(messages || 'Tidak dapat mendaftar pada match ini.', 'error');
            return;
        }

        form.reset();
        showToast('Kamu berhasil mendaftar pada match ini.', 'success');
        await loadMatches();
    }

    function attachBookingHandlers() {
        const bookingForms = matchList.querySelectorAll('.booking-form');
        bookingForms.forEach(form => {
            form.addEventListener('submit', handleBooking);
        });
    }

    searchForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(searchForm);
        loadMatches(formData);
    });

    createForm.addEventListener('submit', handleCreate);
    attachBookingHandlers();
    bindModalEvents();
})();
</script>
{% endif %}
{% endblock %}
